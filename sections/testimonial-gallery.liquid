{{ 'testimonial-gallery.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="testimonial-gallery section-{{ section.id }}-padding">
  <div class="page-width">
    <div class="testimonial-gallery__header">
      {% if section.settings.title != blank %}
        <h2 class="testimonial-gallery__title">{{ section.settings.title }}</h2>
      {% endif %}
      
      {% if section.settings.description != blank %}
        <p class="testimonial-gallery__description">{{ section.settings.description }}</p>
      {% endif %}
    </div>

    <div class="testimonial-gallery__grid">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when 'gallery_item' %}
            <div class="testimonial-gallery__item" {{ block.shopify_attributes }}>
              <div class="gallery-item">
                {% if block.settings.video_url != blank %}
                      <video 
                        class="pt-video" 
                        muted 
                        loop 
                        autoplay 
                        playsinline
                        preload="metadata"
                        data-video-url="{{ block.settings.video_url }}"
                      >
                        {% if block.settings.video_url contains '.mp4' %}
                          <source src="{{ block.settings.video_url }}" type="video/mp4">
                        {% elsif block.settings.video_url contains '.webm' %}
                          <source src="{{ block.settings.video_url }}" type="video/webm">
                        {% else %}
                          <source src="{{ block.settings.video_url }}" type="video/mp4">
                        {% endif %}
                        Your browser does not support the video tag.
                      </video>
                    {% elsif block.settings.video != blank %}
                      <video 
                        class="pt-video" 
                        muted 
                        loop 
                        autoplay 
                        playsinline
                        preload="metadata"
                        data-video-id="{{ block.settings.video.id }}"
                        data-video-url="{{ block.settings.video | file_url }}"
                        data-video-asset="{{ block.settings.video | asset_url }}"
                      >
                        {% if block.settings.video.sources.size > 0 %}
                          {% for source in block.settings.video.sources %}
                            <source src="{{ source.url }}" type="{{ source.mime_type }}">
                          {% endfor %}
                        {% else %}
                          <source src="{{ block.settings.video | file_url }}" type="video/mp4">
                          <source src="{{ block.settings.video | asset_url }}" type="video/mp4">
                        {% endif %}
                        Your browser does not support the video tag.
                      </video>
                    {% elsif block.settings.image != blank %}
                      <img 
                        class="pt-image"
                        src="{{ block.settings.image | image_url: width: 400 }}"
                        alt="{{ block.settings.customer_name | default: 'Customer' }}"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="gallery-item__placeholder">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.51L14.5 12L19 18H5L8.5 13.5Z" fill="currentColor"/>
                        </svg>
                        <span>Add Media</span>
                      </div>
                    {% endif %}
                
                {% if block.settings.caption != blank %}
                  <div class="gallery-item__caption">
                    <span class="caption-text">{{ block.settings.caption }}</span>
                  </div>
                {% endif %}
                
                <!-- Text Overlay for Hover Effect -->
                <div class="gallery-item__overlay">
                  {% if block.settings.customer_name != blank %}
                    <div class="overlay-heading">{{ block.settings.customer_name }}</div>
                  {% endif %}
                  {% if block.settings.customer_role != blank %}
                    <div class="overlay-subheading">{{ block.settings.customer_role }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
        {% endcase %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const gallery = document.querySelector('.testimonial-gallery');
  if (!gallery) return;

  // Handle gallery video loading issues
  const galleryVideos = gallery.querySelectorAll('.pt-video[data-video-url]');
  
  galleryVideos.forEach(function(video) {
    const fileUrl = video.getAttribute('data-video-url');
    const assetUrl = video.getAttribute('data-video-asset');
    
    // Add error handling for video loading
    video.addEventListener('error', function(e) {
      console.log('Gallery video loading error for URL:', fileUrl);
      console.log('Video element:', video);
      
      // Try to reload with asset URL if file URL fails
      if (assetUrl && fileUrl !== assetUrl) {
        console.log('Trying asset URL:', assetUrl);
        const sources = video.querySelectorAll('source');
        sources.forEach(function(source) {
          if (source.src === fileUrl) {
            source.src = assetUrl;
          }
        });
        video.load();
      }
    });
    
    // Add load event listener
    video.addEventListener('loadeddata', function() {
      console.log('Gallery video loaded successfully:', fileUrl);
    });
    
    // Add canplay event listener
    video.addEventListener('canplay', function() {
      console.log('Gallery video can play:', fileUrl);
    });
    
    // Only load if URL is valid
    if (fileUrl && fileUrl !== '') {
      video.load();
    }
  });

  // Add hover effects for gallery items
  const galleryItems = gallery.querySelectorAll('.gallery-item');
  galleryItems.forEach(function(item) {
    item.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.02)';
    });
    
    item.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
    });
  });
});
</script>

{% schema %}
{
  "name": "Testimonial Gallery",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Gallery Title",
      "default": "See Why the Stars Choose Johnny Dang & Co"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Gallery Description",
      "default": "Hear it from the real ones who trust us to elevate their style and make a statement. From custom grills to timeless jewelry, see why the legends choose Johnny Dang & Co. to bring their vision to life."
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "gallery_item",
      "name": "Gallery Item",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Upload a video file for this gallery item"
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL",
          "info": "Enter a direct link to a video file (MP4, WebM, etc.). This will override the uploaded video if provided."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image (Fallback)",
          "info": "This image will be used if no video is uploaded"
        },
        {
          "type": "text",
          "id": "customer_name",
          "label": "Customer Name",
          "default": "Customer"
        },
        {
          "type": "text",
          "id": "customer_role",
          "label": "Customer Role/Profession",
          "default": "MUSICIAN",
          "info": "e.g., MUSICIAN, ACTOR, ATHLETE, etc."
        },
        {
          "type": "text",
          "id": "caption",
          "label": "Caption Text",
          "info": "Optional text overlay for the media"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonial Gallery",
      "blocks": [
        {
          "type": "gallery_item"
        },
        {
          "type": "gallery_item"
        },
        {
          "type": "gallery_item"
        },
        {
          "type": "gallery_item"
        },
        {
          "type": "gallery_item"
        },
        {
          "type": "gallery_item"
        }
      ]
    }
  ]
}
{% endschema %}